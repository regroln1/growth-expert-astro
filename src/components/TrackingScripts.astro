---
// TrackingScripts.astro - Centralized tracking scripts with consent management
---

<!-- Umami Analytics - Only loads with consent -->
<script 
  defer 
  src="https://cloud.umami.is/script.js" 
  data-website-id="e1e5657a-1d06-4b35-8597-7e1092b92e5b"
  data-silktide-category="analytics"
></script>

<!-- Global type declarations -->
<script>
  // Declare global types for TypeScript
  declare global {
    interface Window {
      umami?: {
        track: (eventName: string, eventData?: Record<string, any>) => void;
      };
      trackConversion?: {
        contactFormSubmitted: () => void;
        bookDiscoveryCall: () => void;
        leadMagnetDownloaded: (resourceName: string) => void;
        suitedashCalendarClicked: () => void;
        emailLinkClicked: () => void;
        newsletterSignupClicked: () => void;
        blogPostRead: (postTitle: string) => void;
        methodPageViewed: () => void;
        resourcePageViewed: () => void;
        aboutPageViewed: () => void;
      };
      silktideCookieBannerManager?: {
        updateCookieBannerConfig: (config: any) => void;
      };
    }
  }

  // Wait for Umami to be available
  function waitForUmami(callback: () => void): void {
    if (typeof window !== 'undefined' && window.umami) {
      callback();
    } else {
      setTimeout(() => waitForUmami(callback), 100);
    }
  }

  // Conversion event tracking functions
  window.trackConversion = {
    contactFormSubmitted: function() {
      waitForUmami(() => {
        if (window.umami) {
          window.umami.track('Contact Form Submitted');
          console.log('Tracked: Contact Form Submitted');
        }
      });
    },
    
    bookDiscoveryCall: function() {
      waitForUmami(() => {
        if (window.umami) {
          window.umami.track('Book Discovery Call');
          console.log('Tracked: Book Discovery Call');
        }
      });
    },
    
    leadMagnetDownloaded: function(resourceName: string) {
      waitForUmami(() => {
        if (window.umami) {
          window.umami.track('Lead Magnet Downloaded', { resource: resourceName });
          console.log('Tracked: Lead Magnet Downloaded -', resourceName);
        }
      });
    },
    
    suitedashCalendarClicked: function() {
      waitForUmami(() => {
        if (window.umami) {
          window.umami.track('Suitedash Calendar Clicked');
          console.log('Tracked: Suitedash Calendar Clicked');
        }
      });
    },
    
    emailLinkClicked: function() {
      waitForUmami(() => {
        if (window.umami) {
          window.umami.track('Email Link Clicked');
          console.log('Tracked: Email Link Clicked');
        }
      });
    },
    
    newsletterSignupClicked: function() {
      waitForUmami(() => {
        if (window.umami) {
          window.umami.track('Newsletter Signup Clicked');
          console.log('Tracked: Newsletter Signup Clicked');
        }
      });
    },

    // Additional suggested events
    blogPostRead: function(postTitle: string) {
      waitForUmami(() => {
        if (window.umami) {
          window.umami.track('Blog Post Read', { title: postTitle });
          console.log('Tracked: Blog Post Read -', postTitle);
        }
      });
    },

    methodPageViewed: function() {
      waitForUmami(() => {
        if (window.umami) {
          window.umami.track('Method AIA Page Viewed');
          console.log('Tracked: Method AIA Page Viewed');
        }
      });
    },

    resourcePageViewed: function() {
      waitForUmami(() => {
        if (window.umami) {
          window.umami.track('Resources Page Viewed');
          console.log('Tracked: Resources Page Viewed');
        }
      });
    },

    aboutPageViewed: function() {
      waitForUmami(() => {
        if (window.umami) {
          window.umami.track('About Page Viewed');
          console.log('Tracked: About Page Viewed');
        }
      });
    }
  };

  // Auto-track page views for key pages
  document.addEventListener('DOMContentLoaded', function() {
    const path = window.location.pathname;
    
    if (path === '/methode-aia') {
      window.trackConversion?.methodPageViewed();
    } else if (path === '/ressources') {
      window.trackConversion?.resourcePageViewed();
    } else if (path === '/a-propos') {
      window.trackConversion?.aboutPageViewed();
    } else if (path.startsWith('/blog/') && path !== '/blog') {
      const postTitle = document.querySelector('h1')?.textContent || 'Unknown Post';
      window.trackConversion?.blogPostRead(postTitle);
    }
  });

  // Auto-track email links
  document.addEventListener('click', function(e: Event) {
    const target = e.target as HTMLElement;
    if (target.tagName === 'A') {
      const link = target as HTMLAnchorElement;
      if (link.href.startsWith('mailto:')) {
        window.trackConversion?.emailLinkClicked();
      }
    }
  });
</script>